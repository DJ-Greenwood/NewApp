{% extends 'base.html' %}

{% block title %}Privacy Settings - MyImaginaryFriends.ai{% endblock %}

{% block content %}
    {% include "components/headers/page_header.html" with 
        title="Privacy Settings" 
        subtitle="Control who can see your profile and content" 
        back_url="{% url 'users:profile' %}"
        back_text="Back to Profile"
    %}

    <div class="max-w-3xl mx-auto">
        <div class="bg-white rounded-lg shadow-md overflow-hidden paper-texture">
            <div class="px-6 py-4 border-b border-cream-dark">
                <h3 class="font-serif font-bold text-xl text-navy">Privacy Settings</h3>
            </div>
            
            <form method="post" action="{% url 'users:update_privacy' %}">
                {% csrf_token %}
                
                <div class="p-6 space-y-6">
                    <!-- Profile visibility -->
                    <div>
                        <h4 class="font-bold text-navy mb-3">Profile Visibility</h4>
                        <div class="space-y-4 bg-cream-light p-4 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-bold">Public Profile</div>
                                    <p class="text-sm text-navy-light">
                                        Allow others to view your public profile
                                    </p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="public_profile" class="sr-only peer" {% if user.public_profile %}checked{% endif %}>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-amber rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber"></div>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-bold">Show My Characters</div>
                                    <p class="text-sm text-navy-light">
                                        Allow others to see your public characters
                                    </p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="show_characters" class="sr-only peer" {% if user.show_characters %}checked{% endif %}>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-amber rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber"></div>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-bold">Show My Stories</div>
                                    <p class="text-sm text-navy-light">
                                        Allow others to see your featured stories
                                    </p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="show_stories" class="sr-only peer" {% if user.show_stories %}checked{% endif %}>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-amber rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber"></div>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Discovery settings -->
                    <div>
                        <h4 class="font-bold text-navy mb-3">Discovery Settings</h4>
                        <div class="space-y-4 bg-cream-light p-4 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-bold">Allow Search Discovery</div>
                                    <p class="text-sm text-navy-light">
                                        Allow others to find you through the search feature
                                    </p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="allow_search" class="sr-only peer" {% if user.allow_search %}checked{% endif %}>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-amber rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber"></div>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-bold">Show in Community Activity</div>
                                    <p class="text-sm text-navy-light">
                                        Allow your content to appear in featured community activities
                                    </p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="show_in_community" class="sr-only peer" {% if user.show_in_community %}checked{% endif %}>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-amber rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber"></div>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Content sharing -->
                    <div>
                        <h4 class="font-bold text-navy mb-3">Content Sharing</h4>
                        <div class="space-y-4 bg-cream-light p-4 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-bold">Allow Character Sharing</div>
                                    <p class="text-sm text-navy-light">
                                        Allow others to copy your public characters to their account
                                    </p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="allow_character_sharing" class="sr-only peer" {% if user.allow_character_sharing %}checked{% endif %}>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-amber rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber"></div>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-bold">Show Attribution</div>
                                    <p class="text-sm text-navy-light">
                                        Show your username as the original creator of shared content
                                    </p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="show_attribution" class="sr-only peer" {% if user.show_attribution %}checked{% endif %}>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-amber rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber"></div>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Interaction controls -->
                    <div>
                        <h4 class="font-bold text-navy mb-3">Interaction Controls</h4>
                        <div class="space-y-4 bg-cream-light p-4 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-bold">Allow Collaboration Requests</div>
                                    <p class="text-sm text-navy-light">
                                        Allow others to send you collaboration requests
                                    </p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="allow_collaboration_requests" class="sr-only peer" {% if user.allow_collaboration_requests %}checked{% endif %}>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-amber rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber"></div>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-bold">Allow Messages</div>
                                    <p class="text-sm text-navy-light">
                                        Allow other users to send you direct messages
                                    </p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="allow_messages" class="sr-only peer" {% if user.allow_messages %}checked{% endif %}>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-amber rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber"></div>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Blocked users -->
                    <div>
                        <h4 class="font-bold text-navy mb-3">Blocked Users</h4>
                        <div class="space-y-4 bg-cream-light p-4 rounded-lg">
                            {% if blocked_users %}
                                <div class="space-y-2 max-h-48 overflow-y-auto">
                                    {% for blocked_user in blocked_users %}
                                    <div class="flex items-center justify-between bg-white p-2 rounded-lg">
                                        <div class="flex items-center">
                                            <div class="w-8 h-8 rounded-full bg-navy flex items-center justify-center text-white text-xs mr-2">
                                                {{ blocked_user.username|slice:":1" }}
                                            </div>
                                            <div>
                                                <div class="text-sm font-bold">{{ blocked_user.username }}</div>
                                                <div class="text-xs text-navy-light">Blocked on {{ blocked_user.blocked_date|date:"M d, Y" }}</div>
                                            </div>
                                        </div>
                                        <button type="button" onclick="unblockUser('{{ blocked_user.id }}')" class="text-red-500 hover:text-red-700">
                                            <i class="fas fa-user-times"></i>
                                        </button>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <p class="text-navy-light">You haven't blocked any users.</p>
                                </div>
                            {% endif %}
                            
                            <div class="pt-3 {% if blocked_users %}border-t border-cream-dark{% endif %}">
                                <button type="button" onclick="showBlockUserModal()" class="text-amber hover:text-amber-dark text-sm font-bold">
                                    <i class="fas fa-user-slash mr-1"></i> Block a User
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pt-4 border-t border-cream-dark flex justify-between items-center">
                        <div>
                            <a href="{% url 'users:profile' %}" class="text-navy hover:text-amber transition duration-200">
                                <i class="fas fa-arrow-left mr-1"></i> Back to Profile
                            </a>
                        </div>
                        
                        <button type="submit" class="bg-amber hover:bg-amber-dark text-navy font-bold py-2 px-6 rounded-lg transition duration-200">
                            Save Privacy Settings
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Block User Modal -->
    <div id="block-user-modal" class="hidden fixed inset-0 z-50 bg-navy bg-opacity-75 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-lg max-w-md w-full mx-4 paper-texture">
            <div class="px-6 py-4 border-b border-cream-dark flex justify-between items-center">
                <h3 class="font-serif font-bold text-xl text-navy">Block a User</h3>
                <button 
                    onclick="document.getElementById('block-user-modal').classList.add('hidden')"
                    class="text-navy hover:text-amber focus:outline-none"
                >
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="block-user-form" method="post" action="{% url 'users:block_user' %}">
                {% csrf_token %}
                
                <div class="p-6 space-y-4">
                    <div>
                        <label for="username" class="block text-sm font-medium text-navy mb-1">
                            Username
                        </label>
                        <input 
                            type="text" 
                            id="username" 
                            name="username" 
                            class="w-full rounded-lg border-cream-dark focus:ring-amber focus:border-amber"
                            placeholder="Enter username to block"
                            required
                        >
                    </div>
                    
                    <div class="bg-cream-light p-4 rounded-lg text-sm">
                        <p class="flex items-start">
                            <i class="fas fa-info-circle mt-1 mr-2 text-amber"></i>
                            <span>Blocking a user will prevent them from seeing your content, sending you messages, or sending collaboration requests. They will not be notified that you've blocked them.</span>
                        </p>
                    </div>
                </div>
                
                <div class="px-6 py-4 border-t border-cream-dark bg-cream-light flex justify-end">
                    <button 
                        type="button"
                        onclick="document.getElementById('block-user-modal').classList.add('hidden')"
                        class="bg-gray-300 hover:bg-gray-400 text-navy font-bold py-2 px-4 rounded-lg transition duration-200 mr-2"
                    >
                        Cancel
                    </button>
                    <button 
                        type="submit"
                        class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200"
                    >
                        Block User
                    </button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    function showBlockUserModal() {
        document.getElementById('block-user-modal').classList.remove('hidden');
    }
    
    function unblockUser(userId) {
        if (confirm('Are you sure you want to unblock this user?')) {
            fetch('{% url "users:unblock_user" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ user_id: userId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload the page to show the updated list
                    window.location.reload();
                } else {
                    alert(data.error);
                }
            });
        }
    }
</script>
{% endblock %}